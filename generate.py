#!/usr/bin/env python3

import os
import re
import subprocess

if __name__ == '__main__':

    rdpPortOpenServers = []
    with open('3389_cidrs', 'rt') as f:
        for line in f.readlines():
            cidr = line.strip()

            result = subprocess.run(['nmap', '-p3389', '--open', '-Pn', '-n', cidr], stdout=subprocess.PIPE).stdout.decode()
            for line in result.split('\n'):
                m = re.match(r'^Nmap scan report for (.*)$', line)
                if m:
                    rdpPortOpenServers.append(m.group(1))

    with open('3389_hosts', "wt") as f:
        f.writelines([ip + os.linesep for ip in rdpPortOpenServers])
